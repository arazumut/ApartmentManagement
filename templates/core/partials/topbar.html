{% load static %}
<!-- Topbar Start -->
<header class="app-topbar" id="header">
    <div class="page-container topbar-menu">
        <div class="d-flex align-items-center gap-2">

            <!-- Brand Logo -->
            <a href="{% url 'home' %}" class="logo">
                <span class="logo-light">
                    <span class="logo-lg"><img src="{% static 'images/logo.png' %}" alt="logo"></span>
                    <span class="logo-sm"><img src="{% static 'images/logo-sm.png' %}" alt="small logo"></span>
                </span>

                <span class="logo-dark">
                    <span class="logo-lg"><img src="{% static 'images/logo-dark.png' %}" alt="dark logo"></span>
                    <span class="logo-sm"><img src="{% static 'images/logo-sm.png' %}" alt="small logo"></span>
                </span>
            </a>

            <!-- Sidebar Menu Toggle Button -->
            <button class="sidenav-toggle-button">
                <i class="ri-menu-line"></i>
            </button>

            <!-- Topbar Page Title -->
            <div class="topbar-item d-none d-md-flex px-2">
                <h4 class="mb-0 fs-16">{% block page_title %}Apartman Yönetim Sistemi{% endblock %}</h4>
            </div>

        </div>

        <div class="d-flex align-items-center gap-2">
            <!-- Notification Dropdown -->
            {% if user.is_authenticated %}
            <div class="topbar-item">
                <div class="dropdown noti-dropdown">
                    <a class="dropdown-toggle arrow-none" href="#" role="button" data-bs-toggle="dropdown"
                        aria-haspopup="false" aria-expanded="false">
                        <i class="ri-notification-3-line fs-22"></i>
                        <span class="noti-icon-badge" id="notification-badge"></span>
                    </a>
                    <div class="dropdown-menu dropdown-menu-end dropdown-menu-animated dropdown-lg py-0">
                        <div class="p-2 border-top-0 border-start-0 border-end-0 border-dashed border">
                            <div class="row align-items-center">
                                <div class="col">
                                    <h6 class="m-0 fs-16 fw-semibold">Bildirimler</h6>
                                </div>
                                <div class="col-auto">
                                    <a href="{% url 'mark_all_notifications_read' %}" class="text-dark text-decoration-underline">
                                        <small>Tümünü Okundu İşaretle</small>
                                    </a>
                                </div>
                            </div>
                        </div>

                        <div data-simplebar class="max-h-xs-300" id="notification-list">
                            <!-- Notifications will be loaded via AJAX -->
                            <div class="text-center p-3">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Yükleniyor...</span>
                                </div>
                            </div>
                        </div>

                        <!-- All notifications link -->
                        <a href="{% url 'notification_list' %}"
                            class="dropdown-item text-center text-primary notify-item border-top py-2">
                            Tümünü Gör
                        </a>
                    </div>
                </div>
            </div>

            <!-- Light/Dark Mode Button -->
            <div class="topbar-item d-none d-sm-flex">
                <div>
                    <button class="btn btn-soft-secondary" id="light-dark-mode">
                        <i class="ri-moon-line fs-22"></i>
                    </button>
                </div>
            </div>

            <!-- User Dropdown -->
            <div class="topbar-item nav-user">
                <div class="dropdown">
                    <a class="dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-haspopup="true"
                        aria-expanded="false">
                        <div class="d-flex align-items-center">
                            <div class="d-none d-md-flex flex-column text-end me-2">
                                <span class="fs-14 text-dark">{{ user.get_full_name }}</span>
                                <span class="fs-12 text-muted">{{ user.get_role_display }}</span>
                            </div>
                            <div class="flex-shrink-0">
                                {% if user.profile_picture %}
                                <img src="{{ user.profile_picture.url }}" alt="user-image"
                                    class="rounded-circle avatar-xs">
                                {% else %}
                                <img src="{% static 'images/users/avatar-1.jpg' %}" alt="user-image"
                                    class="rounded-circle avatar-xs">
                                {% endif %}
                            </div>
                        </div>
                    </a>
                    <div class="dropdown-menu dropdown-menu-end dropdown-menu-animated profile-dropdown">
                        <!-- item-->
                        <div class="dropdown-header">
                            <h6 class="text-overflow m-0">Hoş Geldiniz!</h6>
                        </div>

                        <!-- item-->
                        <a href="{% url 'profile' %}" class="dropdown-item">
                            <i class="ri-user-line fs-18 align-middle me-1"></i>
                            <span>Profilim</span>
                        </a>

                        <!-- item-->
                        <a href="{% url 'notification_list' %}" class="dropdown-item">
                            <i class="ri-notification-3-line fs-18 align-middle me-1"></i>
                            <span>Bildirimlerim</span>
                        </a>

                        <!-- item-->
                        <a href="{% url 'logout' %}" class="dropdown-item">
                            <i class="ri-logout-box-line fs-18 align-middle me-1"></i>
                            <span>Çıkış</span>
                        </a>
                    </div>
                </div>
            </div>
            {% else %}
            <div class="topbar-item">
                <a href="{% url 'login' %}" class="btn btn-primary">Giriş</a>
            </div>
            <div class="topbar-item">
                <a href="{% url 'register' %}" class="btn btn-soft-primary">Kayıt Ol</a>
            </div>
            {% endif %}
        </div>
    </div>
</header>
<!-- Topbar End -->

{% block extra_js %}
{% if user.is_authenticated %}
<script>
    // Function to load notifications
    function loadNotifications() {
        fetch('{% url "api_recent_notifications" %}')
            .then(response => response.json())
            .then(data => {
                const notificationList = document.getElementById('notification-list');
                const notificationBadge = document.getElementById('notification-badge');
                
                // Count unread notifications
                const unreadCount = data.notifications.filter(n => !n.is_read).length;
                
                // Update badge
                if (unreadCount > 0) {
                    notificationBadge.style.display = 'block';
                    notificationBadge.textContent = unreadCount > 9 ? '9+' : unreadCount;
                } else {
                    notificationBadge.style.display = 'none';
                }
                
                // Clear loading indicator
                notificationList.innerHTML = '';
                
                // Add notifications or empty message
                if (data.notifications.length === 0) {
                    notificationList.innerHTML = `
                        <div class="text-center p-3">
                            <p class="text-muted mb-0">Bildiriminiz bulunmuyor</p>
                        </div>
                    `;
                } else {
                    data.notifications.forEach(notification => {
                        let iconClass = 'ri-information-line';
                        let bgClass = 'bg-info';
                        
                        if (notification.type === 'success') {
                            iconClass = 'ri-check-line';
                            bgClass = 'bg-success';
                        } else if (notification.type === 'warning') {
                            iconClass = 'ri-alert-line';
                            bgClass = 'bg-warning';
                        } else if (notification.type === 'error') {
                            iconClass = 'ri-error-warning-line';
                            bgClass = 'bg-danger';
                        }
                        
                        const readClass = notification.is_read ? '' : 'bg-light';
                        const newBadge = notification.is_read ? '' : '<span class="badge bg-info ms-1">Yeni</span>';
                        
                        const notificationUrl = notification.link || `{% url 'mark_notification_read' 0 %}`.replace('0', notification.id);
                        
                        notificationList.innerHTML += `
                            <a href="${notificationUrl}" class="dropdown-item p-0 ${readClass}">
                                <div class="d-flex align-items-start p-3">
                                    <div class="flex-shrink-0 me-3">
                                        <div class="avatar-sm">
                                            <span class="avatar-title ${bgClass} rounded-circle">
                                                <i class="${iconClass} text-white"></i>
                                            </span>
                                        </div>
                                    </div>
                                    <div class="flex-grow-1">
                                        <h5 class="mt-0 mb-1 fs-14">
                                            ${notification.title} ${newBadge}
                                        </h5>
                                        <p class="text-muted mb-0 fs-12">${notification.created_at}</p>
                                    </div>
                                </div>
                            </a>
                        `;
                    });
                }
            })
            .catch(error => {
                console.error('Error loading notifications:', error);
                document.getElementById('notification-list').innerHTML = `
                    <div class="text-center p-3">
                        <p class="text-danger mb-0">Bildirimler yüklenirken hata oluştu</p>
                    </div>
                `;
            });
    }
    
    // Load notifications when page loads
    document.addEventListener('DOMContentLoaded', loadNotifications);
    
    // Refresh notifications every 60 seconds
    setInterval(loadNotifications, 60000);
</script>
{% endif %}
{% endblock %}
